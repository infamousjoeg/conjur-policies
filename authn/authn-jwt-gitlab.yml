- !policy
  id: conjur/authn-jwt/gitlab
  annotations:
    description: JWT Authenticator web service for GitLab
  body:
    # Create the conjur/authn-jwt/gitlab web service
    - !webservice

    # Optional: Uncomment any or all of the following variables:
    # * token-app-propery
    # * identity-path
    # * issuer
    # * ca-cert
    # * enforced-claims
    # * mapping-claims
    # * audience
    # identity-path is always used together with token-app-property
    # however, token-app-property can be used without identity-path

    - !variable
      id: token-app-property
      annotations:
        description: JWT Authenticator bases authentication on claims from the JWT. You can base authentication on identifying clams such as the name, the user, and so on. If you can customize the JWT, you can create a custom claim and base authentication on this claim.

    - !variable
      id: identity-path
      annotations:
        description: JWT Authenticator bases authentication on a combination of the claim in the token-app-property and the full path of the application identity (host) in Conjur. This variable is optional, and is used in conjunction with token-app-property. It has no purpose when standing alone.

    - !variable
      id: issuer
      annotations:
        description: JWT Authenticator bases authentication on the JWT issuer. This variable is optional, and is relevant only if there is an iss claim in the JWT. The issuer variable and iss claim values must match.

    - !variable
      id: ca-cert
      annotations:
        description: When the JWKS provider server uses a self-signed certificate or the certificate is signed by third-party CA, use this variable to establish a TLS connection and validate server identity.

    # Mandatory: The JWT Provider URI: You must provide either a public-keys or jwks-uri

    # - !variable
    #   id: public-keys
    #   annotations:
    #     description: The public certificate needed for validating the signed JSON Web Token if a web servie or JSON Web Key Set (JWKS) is not provided.

    - !variable
      id: jwks-uri
      annotations:
        description: A JSON Web Key Set (JWKS) URI. If the JWKS vendor provides both a jwks-uri and an equivalent provider-uri, you can use the provider-uri which has an easier interface to work with.

    # Group of hosts that can authenticate using this JWT Authenticator
    - !group
      id: consumers
      annotations:
        description: Allows authentication through authn-jwt/gitlab web service.
        editable: "true"
    
    # Permit the consumers group to authenticate to the authn-jwt/gitlab web service
    - !permit
      role: !group consumers
      privilege: [ read, authenticate ]
      resource: !webservice

    # Create a web service for checking authn-jwt/gitlab status
    - !webservice
      id: status

    # Group of users who can check the status of authn-jwt/gitlab
    - !group
      id: operators
      annotations:
        description: Group of users that can check the status of the authn-jwt/gitlab authenticator.
        editable: "true"
    
    # Permit group to check the status of authn-jwt/gitlab
    - !permit
      role: !group operators
      privilege: read
      resource: !webservice status
